"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _slicedToArray=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_ramdam=require("ramdam"),_ramdam2=_interopRequireDefault(_ramdam);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(a){return void c(a)}return g.done?void a(h):Promise.resolve(h).then(function(a){d("next",a)},function(a){d("throw",a)})}return d("next")})}}function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}exports.default=function(a){var b=a(),c=_ramdam2.default.addIndex(_ramdam2.default.reduce)(function(a,b,c){return _ramdam2.default.cond([[_ramdam2.default.isString,function(){return _ramdam2.default.isEven(c)?a.collection(b):a.doc(b)}],[_ramdam2.default.isNumber,function(){return a.limit(b)}],[_ramdam2.default.isArray,_ramdam2.default.cond([[_ramdam2.default.equalsLength(3),function(b){return a.where.apply(a,_toConsumableArray(b))}],[_ramdam2.default.both(_ramdam2.default.equalsLength(2),_ramdam2.default.compose(_ramdam2.default.includes(_ramdam2.default.__,["startAt","startAfter","endAt","endBefore"]),_ramdam2.default.head)),function(b){return a[b[0]](b[1])}],[_ramdam2.default.T,function(b){return a.orderBy.apply(a,_toConsumableArray(b))}]])]])(b)},b),d=_ramdam2.default.compose(_ramdam2.default.length,_ramdam2.default.takeWhile(_ramdam2.default.isString)),e=function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(b){var e,f,g;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return e=d(b),f=c(b),a.next=4,f.get();case 4:return g=a.sent,a.abrupt("return",{n:e,ref:f,ss:g});case 6:case"end":return a.stop();}},a,void 0)}));return function(){return a.apply(this,arguments)}}(),f=function(a){var b=d(a),e=c(a);return{ref:e,n:b,query:b!==a.length}},g=function(a){var b=a.shift(),c=f(a),d=c.ref,e=c.n,g=c.query;return{data:b,ref:d,n:e,query:g}},h=function(a){return a.exists?a.data():null},i={d:function e(a){var b=a.ss,c=a.n;if(_ramdam2.default.isOdd(c)){var d=[];return b.forEach(function(a){d.push(a.data())}),d}return h(b)},r:function d(a){var b=a.ss,c=a.n;if(_ramdam2.default.isOdd(c)){var e=[];return b.forEach(function(a){e.push(a)}),e}return b},s:function d(a){var b=a.ss,c=a.n;if(_ramdam2.default.isOdd(c)){var e=[];return b.forEach(function(a){e.push({id:a.id,data:a.data(),ss:a})}),e}return b.exists?{id:b.id,data:b.data(),ss:b}:null},k:function d(a){var b=a.ss,c=a.n;if(_ramdam2.default.isOdd(c)){var e={};return b.forEach(function(a){e[a.id]=a.data()}),e}return h(b)}},j=function(a){var b=a.pop(),e=d(a),f=c(a);return{func:b,n:e,ref:f}},k=_ramdam2.default.map(_ramdam2.default.curry,{write:function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(c,d,e){var h,j,k,l,m,o,p;return regeneratorRuntime.wrap(function(a){var n=Math.min;for(;;)switch(a.prev=a.next){case 0:if(h=_ramdam2.default.includes(c)(["drop","delete"])?f(e):g(e),j=h.data,k=h.ref,l=h.n,m=h.query,!(m||"drop"===c)){a.next=15;break}return a.t0=i,a.t1=l,a.next=6,k.get();case 6:if(a.t2=a.sent,a.t3={n:a.t1,ss:a.t2},o=a.t0.s.call(a.t0,a.t3),!_ramdam2.default.isEmpty(o)){a.next=11;break}return a.abrupt("return");case 11:return p=_ramdam2.default.compose(_ramdam2.default.map(function(a){var e=b.batch(),f=!0,g=!1,h=void 0;try{for(var i,k=a[Symbol.iterator]();!(f=(i=k.next()).done);f=!0){var l=i.value,m=l.ss._ref;_ramdam2.default.includes(c)(["set","update"])?_ramdam2.default.isNotNil(d)?e[c](m,j,d):e[c](m,j):_ramdam2.default.includes(c)(["drop","delete"])&&e.delete(m)}}catch(a){g=!0,h=a}finally{try{!f&&k.return&&k.return()}finally{if(g)throw h}}return e.commit()}),_ramdam2.default.aperture(n(o.length,500)))(o),a.abrupt("return",Promise.all(p));case 15:return a.abrupt("return","delete"===c?k[c]():_ramdam2.default.isNil(d)?k[c](j):k[c](j,d));case 16:case"end":return a.stop();}},a,void 0)}));return function b(){return a.apply(this,arguments)}}(),get:function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(b,c){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=i,a.t1=b,a.next=4,e(c);case 4:return a.t2=a.sent,a.abrupt("return",a.t0[a.t1].call(a.t0,a.t2));case 6:case"end":return a.stop();}},a,void 0)}));return function b(){return a.apply(this,arguments)}}(),on:function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(b,c){var d,e,f,g;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=j(c),e=d.func,f=d.n,g=d.ref,a.abrupt("return",g.onSnapshot(function(a){return e(i[b]({n:f,ss:a}))}));case 2:case"end":return a.stop();}},a,void 0)}));return function b(){return a.apply(this,arguments)}}(),tx:function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(c,d){var e,f,g,h;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return e=j(d),f=e.func,g=e.n,h=e.ref,a.next=3,b.runTransaction(function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(b){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=f,a.t1=b,a.t2=i,a.t3=c,a.t4=g,a.next=7,b.get(h);case 7:return a.t5=a.sent,a.t6={n:a.t4,ss:a.t5},a.t7=a.t2[a.t3].call(a.t2,a.t6),a.t8=h,a.t9={t:a.t1,data:a.t7,ref:a.t8},a.abrupt("return",(0,a.t0)(a.t9));case 13:case"end":return a.stop();}},a,void 0)}));return function(){return a.apply(this,arguments)}}());case 3:return a.abrupt("return",a.sent);case 4:case"end":return a.stop();}},a,void 0)}));return function b(){return a.apply(this,arguments)}}()}),l={inc:a.FieldValue.increment,del:a.FieldValue.delete(),ts:a.Timestamp,batch:function(a){var d=b.batch(),e=!0,f=!1,h=void 0;try{for(var i,j=a[Symbol.iterator]();!(e=(i=j.next()).done);e=!0){var k=i.value,l=k.shift();if(_ramdam2.default.includes(l)(["set","update"])){var m=g(k),n=m.data,o=m.ref;d[l](o,n)}else if("upsert"===l){var p=g(k),q=p.data,r=p.ref;d.set(r,q,{merge:!0})}else if("delete"===l){var s=c(k);d.delete(s)}}}catch(a){f=!0,h=a}finally{try{!e&&j.return&&j.return()}finally{if(f)throw h}}return d.commit()}},m=_ramdam2.default.compose(_ramdam2.default.fromPairs,_ramdam2.default.map(function(a){var b=_slicedToArray(a,2),c=b[0],d=b[1];return[""+c+_ramdam2.default.toUpper(d),_ramdam2.default.unapply(k[c](""===d?"d":d))]}),_ramdam2.default.xprod)(["get","on","tx"],["","k","s","r"]),n=_ramdam2.default.compose(_ramdam2.default.fromPairs,_ramdam2.default.map(function(a){return[a,_ramdam2.default.unapply(k.write("upsert"===a?"set":a,"upsert"===a?{merge:!0}:null))]}))(["add","set","update","upsert","delete","drop"]);return _ramdam2.default.mergeAll([m,l,n])},module.exports=exports.default;